```{r prologue, include=FALSE}
knitr::opts_chunk$set(warning = FALSE
                      , message = FALSE
                      , echo = FALSE
                      )

knitr::opts_template$set(
  fig.wide = list(fig.height = 4.5, fig.width = 8, fig.align='center')
  , fig.wideX = list(fig.height = 3, fig.width = 9, fig.align='center')
  , fig.relaxed = list(fig.height = 6, fig.width = 8, fig.align='center')
  , fig.tile = list(fig.height = 3, fig.width = 3, fig.align='center')
)

par(mar = c(4,3,3,1))
```

```{r initial_load}
library(readr)
library(dplyr)
library(lattice)
library(vcd)
library(MCMCpack)
library(MCMCvis)
source("TC_Theme.R")
link <- "TC_SalesQuota.csv"
raw.data <- read_csv(link) %>%
  transmute(Group = as.factor(Group)
            , KSales = Sales/1000
            , KQuota = Quota/1000
            , MetTarget = Attainment >= 100)

get.col <- function(colnm, grp) {
  as.matrix(raw.data %>% filter(Group == grp) %>% dplyr::select(colnm))
}
set.seed(12321)
```
# Statistical Analysis of Sales Data

##### Julian Hatwell
##### `r format(Sys.time(), "%b %Y")`

## Introduction
Within the sales department, sales agents may be a member of group A or group B. The group membership determines the customer segment that the sales agent will work on. Group B are set much lower quotas (sales targets) on average, reflecting a difference in difficulty to sell to group B customers.

## Brief
Determine if there is any difference between group performance, what (if any) anomalies are present, and to make any recommendations based on the findings.

## Methodology
We will perform basic descriptive statistics on the data set. We will then use Bayesian regression methods to determine whether there is any difference between the goups' performance. Bayesiam methods are preferred for this analysis, because the intention is to estimate the most likely parameter values from a complete census (the entire sales department) rather than making inference to a larger population. Furthermore, checking assumptions and diagnostics for simple Bayesian regression models is much less time consuming.

### Descriptive Statistics
The following listing shows the top 6 rows of the data file followed by a standard summary for the whole sample, and separately by group.

```{r descr_stats, opts.label='fig.wide'}
head(raw.data)
summary(raw.data)
summary(raw.data %>% filter(Group == "A"))
summary(raw.data %>% filter(Group == "B"))
cat("Quota to Sales Correlation")
with(raw.data, cor(KSales, KQuota))
xyplot(KSales~KQuota, data=raw.data
       , groups = Group
       , par.settings = MyLatticeTheme)
```

#### Remarks
As expected, given the brief, Group B has lower Quota and Sales than Group A. There appears to be a very strong correlation between Quota and Sales. This correlation suggests that whoever is setting the quota (targets) at the start of the sales year has an uncanny grasp of the annual sales process.

### Differences in Performance Within Groups
For those who made their targets compared to those who didn't, it's useful to know how much their quotas were influential. A boxplot helps to visualise this for the two groups:

```{r boxplots, opts.label='fig.wideX'}
mns <- round(tapply(raw.data$KQuota, list(raw.data$Group, raw.data$MetTarget), mean),2)
bwplot(KQuota ~ factor(MetTarget) | Group
       , data = raw.data
       , scales = list(format = list(digits = 10))
       , par.settings = MyLatticeTheme
       , strip = MyLatticeStrip
       , xlab = "Met target"
       , ylab = "Quota (1000's units)"
       , main = "Group performance to targets"
       , panel = function(x, y, ...) {
         panel.bwplot(x, y, ...)
         panel.average(x, y
                       , lwd = 2
                       , lty = 1
                       , col = myPalDark[1]
                       , ...)
         panel.text(1:2
                    , mns[which.packet(),] + 5
                    , mns[which.packet(),]
                    , col = myPalDark[1]
                    , cex = 1.1
                    , fontface = "bold"
                    , ...)
       }
)
```

```{r t_tests}
tta <- t.test(get.col("KQuota","A")[get.col("MetTarget", "A")]
            , get.col("KQuota","A")[!get.col("MetTarget", "A")])

tta$data.name <- "Group A: Target not Met / Target Met"

ttb <- t.test(get.col("KQuota","B")[get.col("MetTarget", "B")]
            , get.col("KQuota","B")[!get.col("MetTarget", "B")])

ttb$data.name <- "Group B: Target not Met / Target Met"

tta
ttb
```

#### Remarks
The obvious difference between groups is expected, as per the brief (different customer segments), so the groups are considered separately here. A t-test confirms the visual assessment that there is no significant difference in the distribution of quotas set for those who eventually missed or hit their targets (in either group). The nature of this test means that we could extrapolate the result to a larger population, if one existed. However, this is essentially a census of a whole population (the sales department) so will extend our analysis with Bayesian modeling to determine a credible interval for the underlying parameters, given this fixed data.

### Tests for Between Group Differences in Attainment

#### Log Odds Ratio Test
```{r lor, opts.label='fig.tile' }
with(raw.data, fourfold(table(MetTarget, Group), color = myPalFourFold))
```

#### Remarks
The fourfold plot visualises a log odds ratio test. From the overlapping confidence intervals (in the quadrants' circumferences) and the lighter shading, we can see that this is a non-significant result (significant results have bolder shading). We can conclude that over all, the ratio of Target not Met : Target Met is not different between the groups. However, this test does not control for quota as a covariate.

#### Bayesian Logistic Regression
We create a series Bayesian logistic models to regress the boolean outcome "Met Target" on the Group and KQuota variables, starting with a null (intercept only) model, a model with no interactions and a model including interactions (different slopes for the two groups). The priors are normal distributions around zero. We would like to see if the model parameters converge away from zero and the alternative models have large Bayes Factors.

```{r logistic_models, opts.label='fig.tile'}
b0 <- rep(0, 4)
B0 <- rep(0.2, 4)
model1 <- MCMClogit(I(MetTarget * 1) ~ 1,
                      data=raw.data, b0=b0[1],
                      B0=B0[1],
                      marginal.likelihood="Laplace", mcmc=10000)

model2 <- MCMClogit(I(MetTarget * 1) ~ KQuota + Group,
                      data=raw.data, b0=b0[1:3],
                      B0=B0[1:3],
                      marginal.likelihood="Laplace", mcmc=10000)

model3 <- MCMClogit(I(MetTarget * 1) ~ KQuota * Group,
                      data=raw.data, b0=b0,
                      B0=B0,
                      marginal.likelihood="Laplace", mcmc=10000)

BF <- BayesFactor(model1, model2, model3)
BF$BF.call
cat("log of Bayes Factors")
BF$BF.log.mat
```

#### Remarks
Visual inspection of the MCMC chains and posterior distributions revealed no abnormalities.

The Bayes Factor analysis shows that the model that allows for an interaction term is decively favoured over the null and simpler models. The posterior distributions for the parameters are as follows:

```{r model_summaries, opts.label='fig.wide'}
summary(model3)$quantiles[, c(1, 3, 5)]
MCMCtrace(model3, pdf=FALSE, iter=10000
          , col_den = myPalContrasts[9]
          , col_pr = myPalContrasts[4]
          , col_txt = myPalContrasts[4]
          , lty_pr = 2
          , priors = t(replicate(10000, rnorm(4, b0, B0))))
MCMCplot(model3, ref_ovl = TRUE)
```

From these results, we can see that the intercept and main KQuota slope parameter are trivial, or close to zero. For the posterior distributions of the group B intercept and slope parameters the result is a little more nuanced, with most of their density falling above or below zero. We can interpret this informally as an indication of how likely it is that group B members with a low quota have a greater probability of hitting target - the negative slope indicating that increasing quotas decreases this probability. We might say that the lowest quotas are not as challenging, but only for group B members. The following plot illustrates this result by performing the inverse logit on each of the parameter sets in the MCMC. The median prediction, inter-quartile and and 95% credible intervals are shown for each instance. Redundant marks "T" and "F" show the true outcomes of MetTarget True/False and the top/bottom of the panel for the group B members.

```{r pred_plot, opts.label='fig.wide'}
predict_mcmc_one <- function(x) {
  model3[, 1] + model3[, 2] * raw.data$KQuota[x] +
  model3[, 3] * (raw.data$Group[x] == "B") + 
  model3[, 4] * raw.data$KQuota[x] * (raw.data$Group[x] == "B")
}
preds <- t(sapply(1:nrow(raw.data), predict_mcmc_one))
preds_quants <- t(apply(exp(preds)/ (1 + exp(preds)), 1, quantile))
plot(preds_quants[, 3]~raw.data$KQuota, col = myPalContrasts[as.numeric(raw.data$Group)]
     , pch=20, cex = 0.75
     , ylim= c(0, 1)
     , xlab="Quota"
     , ylab="Modelled Probability of Meeting Target")
segments(x0 = raw.data$KQuota, y0 = preds_quants[, 1], x1 = raw.data$KQuota, y1 = preds_quants[, 5]
         , col = myPalContrasts[as.numeric(raw.data$Group) + 5]
         , lwd = 0.25)
segments(x0 = raw.data$KQuota, y0 = preds_quants[, 2], x1 = raw.data$KQuota, y1 = preds_quants[, 4]
         , col = myPalContrasts[as.numeric(raw.data$Group)]
         , lwd = 1)
legend("topright", legend = paste("group", c("A", "B"), " - median and HDI")
       , col = myPalContrasts[1:2], pch = 20, lty = 1, cex=0.75)
abline(0.5, 0, lty=2, lwd=0.5)
points(MetTarget~KQuota, cex = 0.4
       , data=raw.data, pch = as.character(raw.data$MetTarget)
       , col = myPalContrasts[as.numeric(raw.data$Group)]
       , subset = raw.data$Group == "B")
```

In light of this finding we suggest that it is plausible that individuals in group B with the lowest quotas may be working under a less challenging regime, or those with higher quotas are struggling to meet the targets (or both), when compared to Group A who have a constant level of challenge, whatever the quota. The evidence for this is not absolutely conclusive, but a review of the quota setting for group B may be advisable in order to ensure fairness across the team.

### Closing Remarks
This was a fairly detailed analysis for such a simple dataset. Using Bayesian statistics allowed us to draw conclusions about the closed population directly. This is in contrast with classical (frequentist) statistics that are typically used to make inferences from a sample to a larger population.

## Appendix: Code
```{r initial_load, echo=TRUE, eval=FALSE}
```

```{r descr_stats, echo=TRUE, eval=FALSE}
```

```{r boxplots, echo=TRUE, eval=FALSE}
```

```{r t_tests, echo=TRUE, eval=FALSE}
```

```{r lor, echo=TRUE, eval=FALSE}
```

```{r logistic_models, echo=TRUE, eval=FALSE}
```

```{r model_summaries, echo=TRUE, eval=FALSE}
```

```{r pred_plot, echo=TRUE, eval=FALSE}
```
