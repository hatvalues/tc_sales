```{r prologue, include=FALSE}
library(knitr)
library(stringr)
library(readr)
library(dplyr)
library(lattice)
library(ggplot2)

knitr::opts_chunk$set(warning = FALSE
                      , message = FALSE
                      , echo = FALSE
                      )

knitr::opts_template$set(
  fig.wide = list(fig.height = 4.5, fig.width = 8)
  , fig.wideX = list(fig.height = 3, fig.width = 8)
  , fig.relaxed = list(fig.height = 6, fig.width = 8)
)
```

```{r source_external_code_chunks}
read_chunk("TC_SalesQuota_UtilityCode.R")
read_chunk("TC_SalesQuota_Plots.R")
source("https://raw.githubusercontent.com/julianhatwell/R_Themes/master/TC_Theme.R")
```

```{r Initial_Load}
```
# Investigation of fairness in sales quota setting  

#####Julian Hatwell
#####`r format(Sys.time(), "%b %Y")`
## Introduction  

This report looks at the available data for annual sales for one sales department and seeks to gain assurance that quotas have been set fairly. The company, department and individuals remain anonymous.

The data available are very limited and there are many questions that cannot be answered. This report explains what can be determined based only on the available data.

Within this sales department, quotas are set for each sales agent. An agent may be a member of group A or group B which denotes a specific customer account profile. Group B are set much lower quotas on average, reflecting a difference in difficulty to sell to group B customers.  

The specific question for this investigation is this; Is there any evidence of some kind of bias in the quota setting process? It possible that a group or some individuals are given lower quotas in order to help them meet their targets?

## Executive Summary

The data are limited to the total sales value per agent and two predictors (quota value and group). This report describes the observations made of the data and offers a working theory to explain them but this is based on assumptions that can't be validated. No conclusions can be drawn about deliberate bias or any other underlying cause.

Quota setting is quite accurate at high volume / high sales value. However, the outcomes are extremely variable in the low value region. This implies that the quota originally set for these agents was not a good predictor of their outcome. Some people are being set quotas they can't come anywhere near, while others seem to be set the low end of quotas and breeze through to a high attainment over target.

The working theory for this latter problem is that lower quotas are set where a sales agent is dealing with a tougher customer segment. The person responsible for setting the quotas has the task of balancing the quirks of each customer segment with what they consider to be an achievable target. This process breaks down and becomes unreliable for these more difficult customer groups. There is likely also to be uncertainty introduced simply by the lower volumes of sales coming in at this level.

This problem is characterised differently between the two groups. The quota setting for group B seems to be under cooked, allowing certain individuals to significantly out perform expectations after being given a low quota. Group A on the other hand are not so fortunate. When faced with a low quota, this often isn't set low enough to give them a fair chance of success. 

This summary concludes with a recommendation to perform a  review of the quota setting process for the lower quota range. Id numbers associated with cases of particular interest are included in the appendices so that they can be further investigated on an individual basis.

## Report Detail

Note that the data are a census (complete for the population). This means that inferential statistics are not required. Any differences between the two groups' data, however big or small, are real. They can be described without the use of confidence intervals.

#### Comparing the two groups' performance

```{r boxplot_MetTarget, opts.label='fig.wide'}
```

The inner spots showing the medians and the lines joining the group means show that as a group, A's ability to meet their target is not strongly influenced by the magnitude of the quota. This in itself is quite interesting and defies intuition. Can the quota be set higher and still achieve the same parity?

Group B appear to do better if set a lower target. On the surface this is obvious, but presumably the sales department don't want to make it too easy. Furthermore, why is this not also the case for group A?

```{r group_B_cluster_params}
```

```{r densityplot_MetTarget, opts.label='fig.wide'}
```

This density plot shows where most sales agents fall in terms of their final outcome against target %

Group A shows a classic bell curve centred around their mean attainment to target of `r round(mn_Tar_A,2)` percentage points.  

Group B show a definite skew, possibly the result of 3 discrete clusters. Arbitrary cluster boundaries are suggested by the vertical lines. There are also one or two extreme outliers at either end with \(\pm\) 50% from target. This helps to visualise the much higher variance for this group's overall performance, despite a much narrower range of quotas (see Appendix A for the data summaries).

The lower cluster, comprises the majority of group B members and also has a much lower local average than the group average. The presence of a smaller number of high performers is masking true performance of the majority.

```{r group_B_cluster_analysis}
```

The above table excludes the outliers.  

Without any other information it is impossible to determine whether these clusters are simply sparsity in the data, or whether they're the result of some unknown factor (events during the sales year, bias in the quota setting etc). The id numbers of members of each cluster are available in Appendix B to assist with any follow up research.

```{r ggplot_Sales_depends_Quota, opts.label='fig.wide'}
```

Immediately obvious is the strong, near unity linear relationship between Sales and Quota. This appears to be true for both groups, though a small difference can be seen with Group B not doing quite so well. In units of 1,000 this difference could translate to a significant amount in revenue.

This strong linearity is a non-intuitive observation. Consider that if the simplest model were true, one could simply increase the quotas and expect increased sales up to infinity.    

Sales must reach a limit at some point no matter what quota is set. Some kind of nonlinear relationship is expected, such as the one below (for illustrative purposes only).

```{r expected_nonlinear_increase, opts.label='fig.wideX'}
```

It is assumed that such an underlying tendency is being mediated by the person or persons setting the quotas. This could be by means of a formal process or experience and intuition about easier or tougher customer groups. No specific information is available about the quota setting process but the remainder of the report makes assumption: 

The sales process can modeled as a large binomial; A collection of trials (opportunities, customers) with binary outcomes (sold/not sold) with a certain probability (conversion rate).

The number of opportunities can be variable in this setting and the conversion rate may depend on customer segment.

A low quota (low number of leads/opportunities) would be given where the customer segment take a lot of nurturing with more time spent individually on each. A high quota could be given where the expected conversion rates are high.

The VP or manager in charge of sales has to strike a balance based on these (and possibly other) input parameters to give each sales agent a fair chance of meeting their target. This could results in a highly linear outcome if the process is done accurately.

The following graph, for illustration only, shows the effect of increasing the number of binomial trials. With a constant conversion rate of 5%. Each sales agent would be given Quota * 20 opportunities to work on:

```{r mediated_binomial_sales, opts.label='fig.wideX'}
```

Returning to the data in hand, a linear model is fit in order to better understand the relationships between sales, quota and group:

\[Y = \beta_1X_1 + \beta_2X_2 + \beta_3X_3 + \beta_4X_2X_3\]

where \(Y\) is Sales  
\(X_1\) = 1 for a member of Group A, zero otherwise  
\(X_2\) = 1 for a member of Group B, zero otherwise  
\(X_3\) = Quota (centred at the mean)  

The \(\beta\) terms are coefficients.
The data have been centred such that the intercept \(\beta_0\) is 0. All other terms are in relation to the average quota within a group.

```{r basic_lm}
```

The results are simple and interpretable. Both groups intersect at exactly the average sales given the average quota. Sales has a close to 1:1 relationship with quota for group A, but for group B this is `r round(coef(lm1)[3],4)` + `r round(coef(lm1)[4],4)` = `r round(coef(lm1)[3],4) + round(coef(lm1)[4],4)`. In other words, Group B loses about 10% of their unit sales, simply for being in Group B!

```{r ggplot_pred_lm1, opts.label='fig.wideX'}
```

The residuals plot from the model is unremarkable. 

This is a crude model from simple data. It doesn't reveal anything about what's happening within group B.

````{r ggplot_OnTarget_depends_Quota, opts.label='fig.wide'}
```

The plot above zooms in on the difference between groups A and B. 

The outcome to target is the distance above or below the quota, regardless of actual sales values. Group A, with sales in parity with quota have a line that runs  horizontal along point zero. Group B do better if given a low quota and worse otherwise.

Detail has been added to highlight a cluster of Group B individuals who out performed their initially low quota by around 25 percentage points.

Furthermore, there is a heteroscedastic trend, not in the residuals, but in the data itself. This has been highlighted by the addition of dashed lines.

This is a trend of the variance (spread of the points) which is very high to the left, much lower to the right. It indicates that the expectation of the outcomes at the time the quotas were set was much less reliable for the lower range of quotas. There was more certainty about the outcome at the high value end.  

Perhaps these are the customers who are the tougher sell, giving a lower yield. Or they are low volumes high value customers, where a low season can have a big impact. Whatever it is, sales agents with these customers have to work harder for less overall sales value and have less certain outcomes.

The true reasons for this are unknowable given the very limited information. What it indicates is that there is variable missing from the model.  
This mystery variable is negatively correlated with the quota value. It causes the variance of the outcome to decrease as the quota increases. By taking standard deviation over a rolling window on the outcomes, ordered by quota, it should be possible to derive a representation of the mystery variable.

```{r missing_var_from_variance}
```

````{r ggplot_missing_var, opts.label='fig.wideX'}
````

The plots show the variable derived from the heteroscedastic trend and then its reciprocal (multiplied by 100 for parity with other units). The latter will be referred to as Certainty for the remainder of the report because as Certainty increases, the outcomes become less variable (better predicted by the quota). The units have been ommitted because they are arbritrary. This variable is derived from a trace pattern in the data but the cause of that pattern is not known.

A new linear model is fit, including this derived notion of Certainty.

\[Y = \beta_1X_1 + \beta_2X_2 + \beta_3X_3 + \beta_4X_4 + \beta_5X_2X_3 + \beta_6X_3X_4\]

where \(Y\) is Sales  
\(X_1\) = 1 for a member of Group A, zero otherwise  
\(X_2\) = 1 for a member of Group B, zero otherwise  
\(X_3\) = Certainty, in the listing as oOrollingSD (one over rolling st.dev)  
\(X_4\) = Quota (centred at the mean)  

There are other possible models. This was the best one discovered.

````{r mvar_lm}
```

The coefficients map much more closely to what has been observed in the graphs. Group B has a higher (2,500 unit sales) intercept at the average quota. Quota still has close to 1:1 relationship to Sales. Group B loses 315 sales units for every unit increase in Certainty.

The residuals error measures are fractionally improved over the simpler model. The difference has been checked with ANOVA, and although it's a marginal improvement, the data are a census so it's appropriate to take any improvement as actual without refering to the P or F values.

```{r ggplot_pred_lm.mvar, opts.label='fig.wideX'}
```

The Fitted vs Residuals plot is similarly unremarkable as the first one. 

```{r ggplot_mystery_var, opts.label='fig.wide'}
```

The graph shows the effect of the new Certainty variable on the outcomes. The pattern for group A fits the working theory. The lowest quotas are given to the sales agents with the most difficult customers (difficult in the sense that the yields are lower). Nevertheless they appear still to have struggled. Conversely, for those in Group B, the quota setting process has over-compensated for customer difficulty. They have received the lowest quotas and many of them have ended the year with a high percentage over target.

```{r ggplot_mystery_varB, opts.label='fig.wide'}
```

Zooming in on Group B reveals that this Certainty variable could influence outcomes by around 10% or even more for extreme cases. There is a binary pattern of high and low value either side of a vertical gap. However, this may simply be an artefact of how the variable was derived and caution should be exercised before drawing any conclusions. This gap is used as an abritrary split to create groups who's quota was based on low or high Certainty for the next few graphs.

It only remains to return to the initial discovery of possible clusters in the outcome on target and see if there is any relationship between them.

```{r ggplot_cluster_reprise, opts.label='fig.wideX'}
```

Above, the clusters have been transposed and coloured coded for reference.

```{r ggplot_cluster_analysis, opts.label='fig.wide'}
```

This plot possibly reveals how the clusters have come about. Points at the top left of the plot (low quotas and high achievements) appear to be dragged above and beyond what was expected. There is an equivalent downward drag on those burdened with a larger quota. The skew is introduced and the data separate into the visible bands noted at the start of the investigation.

```{r bwplot_cluster_analysis, opts.label='fig.relaxed'}
```

The box plots show the effect even more clearly. As the view travels from under performance in cluster 1 to high performance in cluster 3, both goups travel up the performance measure, but a split appears between those agents whose final performance better aligned with their quota and those who departed from it. 

In a fair setting, the number of individuals under performing and out performing would be evenly split, as it is in cluster 1. In a challenging target driven setting, there might be a group trend to be slightly under performing. In cluster three, the trend is weighted much more towords over performance.

In these plots at least, it appears to be the case that uncertainty in the low value end of quota setting led to much better results overall for a small group of individuals. This amounts to somewhere around 5% or more on top of what would be expected just for having a lower quota.

To compare the results with Group A, records within the same quota range are taken and split along the same quota boundaries.

```{r bwplot_compare_analysis, opts.label='fig.relaxed'}
```

Here, there is a different trend. There is a very even split between those who diverged above and below their target. 

For the most part, the effect of Certainty aligns with intuition in that the individuals with low certainty are generally at the more extreme position either above or below expectation. There is no clear separation around the given quota based on whether the outcome was above or below expectation.

Yet again, there is an unexplained group that appear to have exceeded their targets by a huge margin despite being in the high Certainty region (the 9 records cut as cluster3A). These individuals are all at the mid to low end of quota values for group A, but not over all for A and B combined. Their ids are available in the appendices for further investigation.

There could be any number of reasons for these patterns. Returning to the working theory; There's a reason the Sales vs Quota plots an almost perfect 1:1 regression line. The Sales manager or VP's responsibility is to mediate an achievable target based on some measure of how easy or difficult a customer is. 
Intuitively, when it comes to Group B, erring on the side of caution seems a plausible explanation. The VP knows these are really difficult customers and undercooks the quota out of a sense of fairness. Firm negotiation from the sales agents who have to work with these difficult clients is another possibility. Deliberate bias can't be ruled out, but there can be no suggestion of it from the available data. The same circumstances may apply at the lower end of Group A but it is not so clear why this effect kicks in a little further up the spectrum of quota values.

The investigation concludes with a reminder that the available data are very limited, with only two predictor variables, plus a third that was derived from a discovered pattern. It can only be offered as a starting point for further investigation at the source.

## Appendices
#### A. Data Sample

The data consist of a csv file with 422 rows and 4 columns. The rows represent individual sales agents in the department. The columns are as follows:

1. Group (A or B) - Denotes the sales department sub-group. Each group sells the same products but has a different client profile and different quotas sales quotas.
2. Sales - The overall sales to date for the year 2015. Units not given.
3. Quota - The overall sales to date for the year 2015. Units not given. Assumed to be same units as sales.
4. Attainment - ratio of \(\frac{Sales}{Quota}\) expressed as a percentage.

For the purpose of convenience, the following columns have been added:

5. KSales - \(\frac{Sales}{1000}\)  

6. KQuota - \(\frac{Quota}{1000}\)  

7. OnTarget - \(\frac{(Sales-Quota)}{Quota}\)  
Centres the Attainment on 100%. The new values is percentage points above or below target.

8. MetTarget - TRUE if OnTarget \(>= 0\), otherwise FALSE

The following listing shows the top 6 rows of the data file followed by a standard summary.

```{r Statistics}
```

#### B. Cluster Ids
Note that these clusters were created based on visible striation in the distribution. They are not the result of a robust analysis and should only be used for illustrative purposes.

```{r Cluster_Ids}
```
