```{r prologue, include=FALSE}
library(knitr)
library(stringr)
library(readr)
library(dplyr)
library(lattice)
library(ggplot2)
library(moments)
library(vcd)
library(vcdExtra)
library(MCMCpack)

knitr::opts_chunk$set(warning = FALSE
                      , message = FALSE
                      , echo = FALSE
                      )

knitr::opts_template$set(
  fig.wide = list(fig.height = 4.5, fig.width = 8, fig.align='center')
  , fig.wideX = list(fig.height = 3, fig.width = 9, fig.align='center')
  , fig.relaxed = list(fig.height = 6, fig.width = 8, fig.align='center')
  , fig.tile = list(fig.height = 3, fig.width = 3, fig.align='center')
)

par(mar = c(4,3,3,1))
```

```{r source_external_code_chunks}
read_chunk("TC_SQ_UCode.R")
read_chunk("TC_SQ_UPlots.R")
source("https://raw.githubusercontent.com/julianhatwell/R_Themes/master/TC_Theme.R")
```

```{r Initial_Load}
```
# Investigation of fairness in sales quota setting  

#####Julian Hatwell
#####`r format(Sys.time(), "%b %Y")`
## Introduction  
This example report, describes a statistical investigation of potential bias in the quota setting process for a sales department. However, the available data are very limited.  

Within this sales department, quotas are set for each sales agent. An agent may be a member of group A or group B which denotes a specific customer account profile. Group B are set much lower quotas on average, reflecting a difference in difficulty to sell to group B customers.  

## Aim
To determine whether it is possible that a group, or some individual(s) have been given lower quotas in order to help them meet their sales targets. 

## Methodology
Standard statistical analyses, both frequentist and Bayesian, are used to examine the data distributions and look for any unusual features, patterns and outliers.

### Descriptive Statistics
As this is a census (whole population), summary statistics are given without SE.

The following listing shows the top 6 rows of the data file followed by a standard summary.

```{r Statistics}
```

#### Remarks
Group B has lower Quota and Sales than Group A, both of which are less variable than Group A. Group A and B deviation from target appears to be almost identical, but Group B's deviation is twice as variable.

### Distributions: Box Plots
For those who made their targets compared to those who didn't, it's useful to know how much their quotas were influential. A boxplot helps to visualise this for the two groups:

```{r boxplot_MetTarget, opts.label='fig.wide'}
```

#### Remarks
Both groups show some outliers above the box plot, indicating some positive skew. The inner spots show the medians and the lines joining the group figures show the means. The difference in means between those who made target and those who didn't  for Group A is `r (mns[1,1]-mns[2,1]) * 1000` units, whilst it's `r (mns[1,2]-mns[2,2]) * 1000` for Group B. The actual revenue impact is unknown.

Reminder: this is a census, not a sample. Any difference in the empirical mean is a true measure, not an estimate. Confidence intervals are not meaningful for this test.

Group Aâ€™s ability to meet their target is apparently not influenced by the magnitude of the quota. This is quite interesting and slightly non-intuitive. Can the quota be set higher and still achieve the same parity? What incentives are in place to go above and beyond quota? This is a question for the sales department to consider.

Group B appear to do better if set a lower target. On the surface this is intuitive.  

### Distributions: Density Plots
A density plot is also useful to visualise the distributions. The next plot shows the density of outcome against target % for the two groups.

```{r densityplot_MetTarget, opts.label='fig.wide'}
```

#### Remarks
Group A shows a bell curve centred around their mean attainment to target of `r round(mn_Tar_A,2)` percentage points. It's extremely close to zero.  

Group B shows very noticeable positive skew with most of the density centred around -15%. It may even be reasonable to suggest that there is a bimodal effect at 25%. One or two extreme outliers lie at either end with \(\pm\) 50% from target.

The above plots helps to visualise the much higher variance for this group's overall performance, despite a much narrower range of quotas (see the Descriptive Statistics). 

### Assumption of Normality Checks
Sample size for Group A is a large for a meaningful Shapiro-Wilk test (Type II errors are expected), but it's reasonable for Group B

```{r moments}
```

```{r moments_plots, opts.label='fig.wide'}
```

#### Remarks
These tests and QQ plots appear to hold some of useful information. Group A is approximately normal in general and the positive skew becomes evident only in the highest values i.e. just the right tail is heavy. This indicates a tendency of a small number to exceed expectations. Group B shows much more positive skew. Both distributions are somewhat leptokurtic.

Plotting the two groups' distributions against each other, the difference is rather stark. Group B are more extreme than group A whether they under or over perform. If this were a QQ Normal plot, it would be interpreted as a distribution very heavy in both tails, though the right tail tail (positive skew) is heavier than the left. 

#### Odds Ratios
One way to determine whether there is link between having a high or low quota and failing to meet the target is to look at the Log Odds Ratios. If the confidence interval for this statistic does not contain zero, this is evidence of an association. A 90% confidence interval is used as a reference for evidence of association.  

Reminder: This data is a census, not a sample. There is some evidence of non-normality in the deviation around the mean. 

The Odds Ratio is calculated by the following formula, using the group median quota as a low-high boundary.

$$Odds \space Ratio = \frac{Odds \space of \space High \space Quota}{Odds \space of \space Missed \space Target} = \frac{High \space Quota/Low \space Quota}{Didn't \space Make \space Target/Made \space Target}$$
$$Log \space Odds \space Ratio = log{(Odds \space Ratio)}$$

```{r odds_ratio}
```

This can be visualised as an Odds Ratio plot and also as a Fourfold plot. 90% confidence bands have been included as a guide. There appears to be weak evidence of association between Quota and performance to target for Group B

```{r odds_ratio_plot, opts.label='fig.wide'}
```

### Linear Models
Next, a look at the relationship between Quota and Sales, using Ordinary Least Squares and Bayes Linear Regression.

```{r ggplot_Sales_depends_Quota, opts.label='fig.wide'}
```

An OLS line has been added to the plot. Immediately obvious is the strong, near unity linear relationship between Sales and Quota. This appears to be true for both groups, though a small difference can be seen between the two. Group B return slightly lower sales per quota. In units of 1,000 this difference could translate to a significant amount in revenue.

A linear relationship with no upper limit is not an intuitive result. See Appendix B for a discussion of the problem associated with these findings.

The coefficients of the OLS line provide empirical measures from the data. A 90% significance test is used for this data, again because it's a full census. Bayes Linear Regression can also be applied, which provides credible intervals for the most likely parameters for the linear model.

```{r basic_lm}
```

The results are simple and interpretable. Taking the OLS stats, Group A has an intersect of `r round(coef(lm1)[1],4)` representing `r round(coef(lm1)[1] * 1000 ,2)` on the average sales given the average quota (effectively zero, it's not significant). Group B has a poorer start with `r round(coef(lm1)[2] * 1000 ,2)` on the average sale given the average quota.

Sales has a close to 1:1 relationship with quota for group A, but for group B this is `r round(coef(lm1)[3],4)` + `r round(coef(lm1)[4],4)` = `r round(coef(lm1)[3],4) + round(coef(lm1)[4],4)`. In other words, Group B makes `r round((coef(lm1)[3] + coef(lm1)[4]) * 100,1)`% of unit sales per unit quota compared to Group A's `r round(coef(lm1)[3] * 100,1)`%.

```{r Bayes_lm}
```

Similarly, Bayes credible intervals for Quota and the Group B specific coefficients do not contain zero at a quantile range of 90%.

The next plot zooms in on the difference between groups A and B. The outcome to target is the distance above or below the quota, regardless of actual sales values. Group A, with sales in parity with quota have a line that runs  horizontal along zero. Group B do better if given a low quota and worse otherwise.

````{r ggplot_OnTarget_depends_Quota, opts.label='fig.wide'}
```

Detail has been added to highlight a possible cluster of Group B individuals who have out performed their initially low quota by around 25 percentage points. There are other more extreme cases so the proximity of these cases may be coincidental.

The are also larger dots highlighting the the two most influential points (in terms of Cook's Distance). Both are members of Group B with the highest quotas. One person is far outside the normal range and one has to question the classification. However, there is a point both above and below the line with a very strong influence, their influence is balanced as can be seen by the following plot which uses a loess line.

```{r varianceTrend}
```

```{r ggplot_OnTarget_Loess, opts.label='fig.wide'}
```

Here, it can be seen that the cluster identified are exerting a skewing influence.

Furthermore, note that there is a heteroscedastic-like trend in the tendency of the variance which is very high to the left, much lower to the right. This has been highlighted by the addition of dashed lines. The effect  been modelled by means of a leave-one-out calculation and a second loess line has been superimposed on the graph to visualise it. The line for Group A is exceptionally linear despite this type of model's inherent flexibility.

## Conclusions
There is evidence for both greater varability with the lower quotas and positive skew. There could be any number of reasons for these patterns. The Sales manager or VP's responsibility is to mediate an achievable target based on some measure of how easy or difficult a customer segement is.

Intuitively, when it comes to Group B, erring on the side of caution seems a plausible explanation. The VP knows these are really difficult customers and undercooks the quota out of a sense of fairness. Firm negotiation from the sales agents who have to work with these difficult clients is another possibility. Deliberate bias can't be ruled out, but there can be no suggestion of it from the available data.

The investigation concludes with a reminder that the available data are very limited, with only two predictor variables. It can only be offered as a starting point for further investigation at the source.

## Appendices

#### A. Data Dictionary

The data consist of a csv file with 422 rows and 4 columns. The rows represent individual sales agents in the department. The columns are as follows:

1. Group (A or B) - Denotes the sales department sub-group. Each group sells the same products but has a different client profile and different quotas sales quotas.
2. Sales - The overall sales to date for the year 2015. Units not given.
3. Quota - The overall sales to date for the year 2015. Units not given. Assumed to be same units as sales.
4. Attainment - ratio of \(\frac{Sales}{Quota}\) expressed as a percentage.

For the purpose of convenience, the following columns have been added:

5. KSales - \(\frac{Sales}{1000}\)  

6. KQuota - \(\frac{Quota}{1000}\)  

7. OnTarget - \(\frac{(Sales-Quota)}{Quota}\)  
Centres the Attainment on 100%. The new values is percentage points above or below target.

8. MetTarget - TRUE if OnTarget \(>= 0\), otherwise FALSE

9. Quota_Size - "High" if above the group median "Low" otherwise.


#### B. Discussion of Linear trend between Quota and Sales

The strong linearity is a non-intuitive observation. Consider that if the simplest model were true, one could simply increase the quotas and expect increased sales up to infinity. Sales must reach a limit at some point no matter what quota is set. Some kind of nonlinear relationship is expected, such as the one below (for illustrative purposes only).

```{r expected_nonlinear_increase, opts.label='fig.wideX'}
```

It has to be assumed that such an underlying tendency is being mediated by the person or persons setting the quotas. This could be by means of a formal process or experience and intuition about easier or tougher customer groups. No specific information is available about the quota setting process but the remainder of the report makes this assumption: 

The sales process can modeled as a large binomial; A collection of trials (opportunities, customers) with binary outcomes (sold/not sold) with a certain probability (conversion rate).

The number of opportunities can be variable in this setting and the conversion rate may depend on customer segment.

A low quota (low number of leads/opportunities) would be given where the customer segment take a lot of nurturing with more time spent individually on each. A high quota could be given where the expected conversion rates are high.

The VP or manager in charge of sales has to strike a balance based on these (and possibly other) input parameters to give each sales agent a fair chance of meeting their target. This could results in a highly linear outcome if the process is done accurately.

The following graph, for illustration only, shows the effect of increasing the number of binomial trials. With a constant conversion rate of 5%. Each sales agent would be given Quota * 20 opportunities to work on:

```{r mediated_binomial_sales, opts.label='fig.wideX'}
```

Of course, conversion rate would start to fall for higher and higher numbers of opportunities, as the sales agent will not be able to devote enough time to nurture each one. This is where the domain knowledge of the agent and manager comes in to set themselves realistic targets.