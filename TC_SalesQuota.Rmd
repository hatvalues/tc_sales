```{r global_options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=6)
```

```{r load_libraries}
library(knitr)
library(readr)
library(dplyr)
library(ggplot2)
library(lattice)
```

---
title: "Investigation of fairness in sales quota setting"
author: "Julian Hatwell"
date: `r format(Sys.time(), "%b %Y") `
output: html_document
---

## Introduction

This report looks at the available data for annual sales for one sales department and seeks to gain assurance that quotas have been set fairly for all members of the sales department. The company, department and individuals remain anonymous.

The data available is very limited and there are many questions that cannot be answered. This report seeks to determine what can be inferred based only on the available data.

## Executive Summary

The specific question for this investigation is this; Given that the determination of group membership is not completely objective (i.e. does not follow a set cut off or threshold for Quota), is it possible that a group or some individuals are given lower quotas in order to help them meet their targets?

This report concludes that a small cluster in the group of interest have performed well enough to improve the whole group average. It seems unlikely that any process has been rigged but perhaps a dataset including previous year performances and more information about quota setting could add some context.

If nothing else, this high performing group could be a case study for more general improvements in the department though sharing of best practice.

## Detailed Report
### Data Sample and Exploratory Data Analysis

The data is a census (complete for the population) and so inferential statistics are not required. Means and variances can be discussed and considered as is,  without the need for standard errors and confidence intervals with which the reader might be accustomed.

The data consists of a csv file with 422 rows and 4 columns. The rows represent individual sales agents in the department. The columns are as follows:

1. Group (A or B) - Denotes the sales department sub-group. Each group sells the same products but has a different client profile and different quotas sales quotas.
2. Sales - The overall sales to date for the year 2015. Units not given.
3. Quota - The overall sales to date for the year 2015. Units not given. Assumed to be same units as sales.
4. Attainment - ratio of \(\frac{Sales}{Quota}\) expressed as a percentage.

For the purpose of convenience, the following columns have been added:

5. KSales - \(\frac{Sales}{1000}\)  

6. KQuota - \(\frac{Quota}{1000}\)  

7. OnTarget - \(\frac{(Sales-Quota)}{Quota}\)  
Centres on 100%. The values is now percentage points above or below target.

The following listing shows the top 6 rows of the data file followed by a standard summary.

```{r load_data}
# original link
link <- "https://raw.githubusercontent.com/julianhatwell/TC_SalesQuotas/master/TC_SalesQuota.csv"
# local file
#link <- "C:\\Dev\\Study\\R\\Tanc_investigation\\TC_SalesQuota.csv"
raw.data <- read_csv(link)
attach(raw.data)
raw.data$Group <- as.factor(Group)
raw.data$id <- seq_along(Sales)
raw.data$KSales <- Sales/1000
raw.data$KQuota <- Quota/1000
raw.data$OnTarget <- (Sales-Quota)/Quota*100

attach(raw.data)
head(raw.data)
summary(select(raw.data, -c(Sales,Quota, Attainment)))
```

The means and st. devs of the population and separately for groups A and B are presented here for reference:

```{r means_stdevs_sales_quota}
# means
# pop
mn_Quo_P <- mean(KQuota)
mn_Sal_P <- mean(KSales)
mn_Tar_P <- mean(OnTarget)
kable(data.frame(
  Population_mean_KQuota = mn_Quo_P
  , Population_mean_KSales = mn_Sal_P
  , Population_mean_OnTarget = mn_Tar_P
))

# Grp A
mn_Quo_A <- mean(KQuota[Group == "A"])
mn_Sal_A <- mean(KSales[Group == "A"])
mn_Tar_A <- mean(OnTarget[Group == "A"])
kable(data.frame(
  GroupA_mean_KQuota = mn_Quo_A
  , GroupA_mean_KSales = mn_Sal_A
  , GroupA_mean_OnTarget = mn_Tar_A
))

# Grp B
mn_Quo_B <- mean(KQuota[Group == "B"])
mn_Sal_B <- mean(KSales[Group == "B"])
mn_Tar_B <- mean(OnTarget[Group == "B"])
kable(data.frame(
  GroupB_mean_KQuota = mn_Quo_B
  , GroupB_mean_KSales = mn_Sal_B
  , GroupB_mean_OnTarget = mn_Tar_B
))

# St Devs
# Pop
sd_Quo_P <- sd(KQuota)
sd_Sal_P <- sd(KSales)
sd_Tar_P <- sd(OnTarget)
kable(data.frame(
      Population_StDev_KQuota = sd_Quo_P
      , Population_StDev_KSales = sd_Sal_P
      , Population_StDev_OnTarget = sd_Tar_P
))

# Grp A
sd_Quo_A <- sd(KQuota[Group == "A"])
sd_Sal_A <- sd(KSales[Group == "A"])
sd_Tar_A <- sd(OnTarget[Group == "A"])
kable(data.frame(
      GroupA_StDev_KQuota = sd_Quo_A
      , GroupA_StDev_KSales = sd_Sal_A
      , GroupA_StDev_OnTarget = sd_Tar_A
))

# Grp B
sd_Quo_B <- sd(KQuota[Group == "B"])
sd_Sal_B <- sd(KSales[Group == "B"])
sd_Tar_B <- sd(OnTarget[Group == "B"])
kable(data.frame(
      GroupB_StDev_KQuota = sd_Quo_B
      , GroupB_StDev_KSales = sd_Sal_B
      , GroupB_StDev_OnTarget = sd_Tar_B
))
```

In general, group B has a much smaller size and much smaller variance in the sales and quota, yet it has a much wider variance in the on target attainment variable. It seems that attainment in group B is less easy to predict, given either sales or quota. 

The following figure demonstrates a clear trend between sales and quota which appears to be irrespective of group. The lower values for mean quota and sales for Group B are clear.

This information was not explicit in the information given with the data set, but seems to corroborate the face that these groups have different customer profiles. Group B appear to have the "tougher" sell and consequently sytematically lower quotas, though there are a significant number of exceptions.

An identity reference dotted line has been added to emphasise the almost exact 1:1 relationship with between Quota and Sales for group A. Group B shows a slope coefficient very slightly below 1. This will be quantified in later in the report with a linear model

```{r Exploratory_Graph_Sales_depends_Quota}
# smooth line shows the strong trend between quota and sales
q <- qplot(data = raw.data
      , x = KQuota, y = KSales
      , colour = Group
      , alpha = I(0.5))
q <- q + geom_smooth(method = "lm", se = FALSE, size = 1.25)
q <- q + geom_abline(intercept=0, slope=1, linetype = "dotted", alpha = 0.75)
q <- q + labs(list(title = "Sales by Quota by Group \nwith lm fit and identity line"
              , x = "Quota (1000's)", y = "Sales (1000's)")) + theme_bw()
q
```

### Attainment / Target

The attainment variable supplied in the data set is simply the ratio of \(\frac{Sales}{Quota}\) and represents the performance of individual sales agents. It is equivalent to fitting linear model Sales depends on Quota, assuming the intercept is 0.

More generally

\[\hat{Y}_i = \beta_0 + \beta_1X_i + e_i\]

where \(\hat{Y}_i\) is the predicted Sales value for individual given the Quota \(X_i\). 

\(\beta_0\) (intercept) is observed to be zero or very close for the observed model while \(\beta_1\) is the expectation that an individual agent can exactly meet their sales target.

\(e_i\) is the deviation from \(\hat{Y}_i\) for the individual sales person and is of the most interest for the purposes of this investigation. 

The task at hand is to try to determine if there are any discernable patterns to \(e\), and if the combination of Quota and Group setting could control any discovered  pattern in particular if there were a practical way to apply such influence.


The following figure shows that the on target attainment for group A is relatively constant, no matter what the Quota (as we have already seen). 

For Group B the picture is not so clear. In the shadow of much higher variance, there are some signs of a different trend; Those with lower quotas may be finding it easier to meet and exceed the attainment while those with higher quotas struggle. This pattern is less clear and the regression line may be heavily influenced by a small number of significant outliers.

There is a pattern of heteroscedasticity over the whole population, whereby the lower quotas are much poorer estimators of sales than the higher quotas. This could also be a factor influencing group B outcomes because they are all in the lower range of quotas.

```{r Exploratory_Graph_Attainment_Quota}
q <- qplot(data = raw.data, x = KQuota, y = OnTarget
      , colour = Group, alpha = I(0.5))
q <- q + geom_smooth(method = "lm", se = FALSE, size = 1.25)
q <- q + labs(list(title = "Attainment by Quota by Group with lm fit"
              , x = "Quota (1000's)", y = "Sales (1000's)")) + theme_bw()
q
```

The regression line for group B notably passing through the point with the highest quota. This is potentially a high leverage point and needs further investigation.

The following figure shows a histogram of the Attainment in each group. There is a noticeable skew to the Group B distribution.

```{r Histogram_Attainment}
# These groups have the same average attainment 
# but do they have the same distributions?
histogram(~OnTarget | Group, layout = c(1, 2), breaks = 20
          , main = "Histogram of group A and B attainment for comparison")
```

The following figure shows a Quantile-Quantile plot, reflecting the above mentioned skew.

```{r QQ_Group_Attainment}
# quantiles plot against T disp df = sample size -1.
qq(Group~OnTarget
   , type=c("p", "g")
   , main = "Q-Q Attainment Grp A vs B"
   , aspect = "xy"
)
```

Group B appear to be over represented in the lower attainment group. There must be correspondingly a small set of high performers who pull up the group average to resemble Group A's mean.

## Linear Models
There are not many variables to choose from. 

### 1. How does the quota affect sales
Based on the assumptions that quotas are set to drive sales, the first model looks at predicted attainment, the coefficent of Sales ~ Quota for the two groups. The data is centred for each group with X - mu

```{r lm_Sales_depends_Quota_and_Group}
# centering each group in its attainment mean
raw.data$Sales_C <- KSales - ifelse(Group == "A", mn_Sal_A, mn_Sal_B)
raw.data$Quota_C <- KQuota - ifelse(Group == "A", mn_Quo_A, mn_Quo_B)
raw.data$OnTarget_C <- OnTarget - ifelse(Group == "A", mn_Tar_A, mn_Tar_B)

attach(raw.data)

lm1 <- lm(Sales_C ~ Group * Quota_C -1)
summary(lm1)
```

We see, unsurprisingly a slope coefficient for Group A of 0.99538, almost exactly an identity line as we've seen in the EDA.

Group B rises at a very slightly lower rate, 0.995 - 0.093 = 0.902
Although the P-Value is 0.07, the reader is reminded that this is a census, not a sample and the differences are real, absolute and not inferred.

This difference in slope can be interpreted as Group A sells 995.4 units for every 1000 units of quota. Group B sells 902.2 units for every 1000 units of quota.

The next plot is the residuals cooks distances. Three very influential points are evident. 

```{r Resid_plot_lm1}
plot(lm1, which = 4)
```

The following is the model and plot excluding these variables.

```{r lm_Sales_depends_Quota_and_Group_exclude_outliers}
outliers <- c(389,180,373)
removeCooks <- raw.data[-outliers,]
lm2 <- lm(Sales_C ~ Group * Quota_C -1, data = removeCooks)
summary(lm2)
```

```{r Exploratory_Graph_Attainment_Quota_exclude_outliers}
q <- qplot(data = removeCooks, x = Quota, y = OnTarget
      , colour = Group, alpha = I(0.5))
q <- q + geom_smooth(method = "lm", se = FALSE, size = 1.25)
q + ggtitle("Attainment by Quota by Group with lm fit\nexcluding outliers") + theme_bw()
```

The negative difference in slope coefficient (reduction in on target attainment) is greater, indicating that these three points are highly influential and pulling up the attainment for the whole of group B.

```{r outlier_quotas}
mn_Quo_P <- mean(KQuota)
mn_Sal_P <- mean(KSales)
mn_Tar_P <- mean(OnTarget)
kable(data.frame(
        Sales_Agent = outliers
        , KQuota = raw.data[outliers, c("KQuota")]
        , Group = raw.data[outliers, c("Group")]))
kable(data.frame(
        Population_mean_KQuota = mn_Quo_P
        , GroupA_mean_KQuota = mn_Quo_A
        , GroupB_mean_KQuota = mn_Quo_B))

```

Clearly the two members of group B have not been given unduly easy quotas compared to the group average.

The following plot is the residuals in increasing order, seeking any discernable pattern in their distribution.

```{r Resid_Diagnostics}
n = nrow(raw.data)
id = 1:n
lm1_res_dgn <- data.frame(res = sort(resid(lm1))
                          , idx = as.numeric(names(sort(resid(lm1))))
                          , id= id, row.names = id)
lm1_res_dgn$KQuota <- KQuota[lm1_res_dgn$idx]
lm1_res_dgn$Group <- Group[lm1_res_dgn$idx]
lm1_res_dgn$jitter <- rnorm(n, sd = 0.25)

xyplot((res+jitter)~id
       , data = lm1_res_dgn
       , group = Group
       , main = list("Ordered Residuals", cex = 1)
       , ylab = "Jittered on target attainment (residuals)"
       , prepanel = function(x,y,...) { 
                      list(ylim = c(-20, 15))
       }
       , panel = function(x,y,...) {
         panel.xyplot(x,y,..., alpha = c(0.5, 0.8), pch = c(1, 19))
         panel.xyplot(x,y = lm1_res_dgn$KQuota/5-20,...
                      , alpha = c(0.4, 0.5), type = "l")
        panel.abline(v=c(175, 340, 380), lty = "dotted", col = "black", alpha = 0.5)
         panel.text(c("Underperformance\nis over-represented\nin Group B"
                      ,"Group B sparsely\nrepresented in\nneutral region"
                      ,"Small cluster of\nhigh performers")
                      , x = c(75,250,360), y = c(4,7,10), cex = 0.7)
       })
```

From the plot, it is perhaps not asking too much to accept verification of the early diagnosis. Group B appear to be somewhat over-represented in the underperformers, while a small cluster of higher performers may pull up the over all average. 

The Quota (scaled) has been superimposed on the series to seek any relationship between it the on target attainment, but there seems to be nothing beyond a noisy flat line.

The following plot show the ordered Cooks Distances of the the model residuals. Here the effect of the high variance in Group B is very clear. The leverage exerted by the top 5 most influential points is completely disproportionate.

```{r cooks_diagnostics}
n = nrow(raw.data)
id = 1:n
lm1_cks_dgn <- data.frame(cks = sort(cooks.distance(lm1))
                          , idx = as.numeric(names(sort(cooks.distance(lm1))))
                          , id= id, row.names = id)
lm1_cks_dgn$KQuota <- KQuota[lm1_cks_dgn$idx]
lm1_cks_dgn$OnTarget <- OnTarget[lm1_cks_dgn$idx]
lm1_cks_dgn$Group <- Group[lm1_cks_dgn$idx]
lm1_cks_dgn$jitter <- rnorm(n, sd = 0.001)

xyplot((cks+jitter)~id
       , data = lm1_cks_dgn
       , group = Group
       , main = list("Ordered Residual Cooks Distances", cex = 1)
       , ylab = "Jittered residuals Cooks distances"
       , panel = function(x,y,...) {
         panel.xyplot(x,y,..., alpha = c(0.4, 0.8), pch = c(1, 19))
         panel.xyplot(x,y = lm1_cks_dgn$KQuota/500+0.1,...
                      , alpha = c(0.4, 0.5), type = "l")
         panel.abline(v=328, lty = "dotted", col = "black", alpha = 0.5)
         panel.text("High variance\nin Group B"
                    , x = 375, y = 0.075, cex = 0.7)
         })
```

Looking at their direction of influence, however, reveals a rather even split:



#### Side note on the linear relationship; Sales depends on Quota:

The simple 1:1 relationship so far discovered, is actually rather unintuitive as it is not conceivable that one could continually increase the quota and get a linear increase in sales to infinity. The reality is much more likely to be a log-linear relationship, with sales vastly outstripping lower quotas then trailing behind higher and higher quotas to a limit. It is assumed that these log-linear relationships are being mediated by a variable modeling easier or tougher customer groups. This is perhaps the task of the sales manager or VP in charge to ensure the targets are realistic and achievable for each individual.

Without any information about how the customers are modeled, the linear relationship is assumed to be this intuited variable combined with the log-linear relationship all rolled up into the value of \(\beta_1\) of the linear model. No judgements can be made with the available data about how fair the the process of quota setting is at this level of detail.

```{r expected_loglinear_increase_in_sales}
x <- seq(5, 80, 0.5)
y <- 9*log(x) + rnorm(length(x))
xyplot(y~x, main = list("Intuitive relationship of Sales to Quotas\n(Simulation)", cex = 1)
      , xlab = "Quota (1000's)", ylab = "Sales (1000's)")
```

This report concludes that there has been no obvious rigging of the quotas, though further investigation of the small high performing cluster in Group B may be of interest if for no other reason than to learn from their best practices. It is hoped that sharing of best practice among sales agents is already taking place year on year.