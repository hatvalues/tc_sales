```{r global_options, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=6)
```

```{r load_libraries}
library(knitr)
library(readr)
library(dplyr)
library(ggplot2)
library(lattice)
```

---
title: "Investigation of fairness in sales quota setting"
author: "Julian Hatwell"
date: `r format(Sys.time(), "%b %Y") `
output: html_document
---

## Introduction

This report looks at the available data for annual sales for one sales department and seeks to gain assurance that quotas have been set fairly. The company, department and individuals remain anonymous.

The data available are very limited and there are many questions that cannot be answered. This report seeks to determine what can be determined based only on the available data.

## Executive Summary

Within this sales department, quotas are set for each sales agent. An agent may be a member of group A or group B which denotes a specific customer account profile. Group B are set much lower quotas on average, reflecting a difference in difficulty to sell to group B customers. Nevertheless, the quota setting is highly variable for both groups, perhaps reflecting a subjective element or other factor in customer profiling and there may be scope to give certain sales agents a more favourable outcome.

The specific question for this investigation is this; Given that the determination of group membership is not completely objective (i.e. does not follow a set cut off or threshold for Quota), is it possible that a group or some individuals are given lower quotas in order to help them meet their targets?

## Detailed Report
### Data Sample and Exploratory Data Analysis

The data consists of a csv file with 422 rows and 4 columns. The rows represent individual sales agents in the department. The columns are as follows:

1. Group (A or B) - Denotes the sales department sub-group. Each group sells the same products but has a different client profile and different quotas sales quotas.
2. Sales - The overall sales to date for the year 2015. Units not given.
3. Quota - The overall sales to date for the year 2015. Units not given. Assumed to be same units as sales.
4. Attainment - ratio of \(\frac{Sales}{Quota}\) expressed as a percentage.

For the purpose of convenience, the following columns have been added:

5. KSales - \(\frac{Sales}{1000}\)  

6. KQuota - \(\frac{Quota}{1000}\)  

7. OnTarget - \(\frac{(Sales-Quota)}{Quota}\)  
Centres on 100%. The values is now percentage points above or below target.

8. MadeTarget - TRUE if OnTarget \(>= 0\), otherwise FALSE

The following listing shows the top 6 rows of the data file followed by a standard summary.

```{r load_data}
# original link
link <- "https://raw.githubusercontent.com/julianhatwell/TC_SalesQuotas/master/TC_SalesQuota.csv"
# local file
#link <- "C:\\Dev\\Study\\R\\Tanc_investigation\\TC_SalesQuota.csv"
raw.data <- read_csv(link)
attach(raw.data)
raw.data$Group <- as.factor(Group)
raw.data$KSales <- Sales/1000
raw.data$KQuota <- Quota/1000
raw.data$OnTarget <- (Sales-Quota)/Quota*100
raw.data$MadeTarget <- raw.data$OnTarget >= 0

attach(raw.data)
head(raw.data)
summary(select(raw.data, -c(Sales,Quota, Attainment)))
```

The following boxplot shows the distribution of quotas set among those who made their quota and those who didn't. The two groups are compared:

```{r boxplot_MadeTarget}
bwplot(KQuota ~ factor(MadeTarget) | Group)
```

The data is a census (complete for the population) and so inferential statistics are not required. All statistics are descriptive without the need for standard errors and confidence intervals with which the reader might be accustomed. The difference in performance visible in Group B is real and should be quantified. The plot can be interpreted as follows:

Taken as a whole, Group A's ability to make their target is not influenced by the quota setting. In contrast members in Group B who were set lower quotas were more somewhat more likely to exceed their targets and those with higher quotas more likely to fail. The difference is small but noticeable.

The means and st. devs of the population and separately for groups A and B are presented here for reference:

```{r means_stdevs_sales_quota}
# means
# pop
mn_Quo_P <- mean(KQuota)
mn_Sal_P <- mean(KSales)
mn_Tar_P <- mean(OnTarget)
kable(data.frame(
  Population_mean_KQuota = mn_Quo_P
  , Population_mean_KSales = mn_Sal_P
  , Population_mean_OnTarget = mn_Tar_P
))

# Grp A
mn_Quo_A <- mean(KQuota[Group == "A"])
mn_Sal_A <- mean(KSales[Group == "A"])
mn_Tar_A <- mean(OnTarget[Group == "A"])
kable(data.frame(
  GroupA_mean_KQuota = mn_Quo_A
  , GroupA_mean_KSales = mn_Sal_A
  , GroupA_mean_OnTarget = mn_Tar_A
))

# Grp B
mn_Quo_B <- mean(KQuota[Group == "B"])
mn_Sal_B <- mean(KSales[Group == "B"])
mn_Tar_B <- mean(OnTarget[Group == "B"])
kable(data.frame(
  GroupB_mean_KQuota = mn_Quo_B
  , GroupB_mean_KSales = mn_Sal_B
  , GroupB_mean_OnTarget = mn_Tar_B
))

# St Devs
# Pop
sd_Quo_P <- sd(KQuota)
sd_Sal_P <- sd(KSales)
sd_Tar_P <- sd(OnTarget)
kable(data.frame(
      Population_StDev_KQuota = sd_Quo_P
      , Population_StDev_KSales = sd_Sal_P
      , Population_StDev_OnTarget = sd_Tar_P
))

# Grp A
sd_Quo_A <- sd(KQuota[Group == "A"])
sd_Sal_A <- sd(KSales[Group == "A"])
sd_Tar_A <- sd(OnTarget[Group == "A"])
kable(data.frame(
      GroupA_StDev_KQuota = sd_Quo_A
      , GroupA_StDev_KSales = sd_Sal_A
      , GroupA_StDev_OnTarget = sd_Tar_A
))

# Grp B
sd_Quo_B <- sd(KQuota[Group == "B"])
sd_Sal_B <- sd(KSales[Group == "B"])
sd_Tar_B <- sd(OnTarget[Group == "B"])
kable(data.frame(
      GroupB_StDev_KQuota = sd_Quo_B
      , GroupB_StDev_KSales = sd_Sal_B
      , GroupB_StDev_OnTarget = sd_Tar_B
))
```

In general, group B has a much smaller size and much smaller variance in the sales and quota, yet it has a much wider variance in the on target attainment variable. It seems that attainment in group B is less easy to predict for any given quota. 

The following figure demonstrates a clear trend between sales and quota which appears to be irrespective of group. The lower values for mean quota and sales for Group B are clear.

This information was not explicit in the information given with the data set, but seems to corroborate the fact that these groups have different customer profiles. Group B appear to have the "tougher" sell and consequently sytematically lower quotas, though there are a significant number of exceptions.

An identity reference dotted line has been added to emphasise the almost exact 1:1 relationship with between Quota and Sales for group A. Group B shows a slope coefficient very slightly below 1. This will be quantified in later in the report with a linear model

```{r Exploratory_Graph_Sales_depends_Quota}
# smooth line shows the strong trend between quota and sales
q <- qplot(data = raw.data
      , x = KQuota, y = KSales
      , colour = Group
      , alpha = I(0.5))
q <- q + geom_smooth(method = "lm", se = FALSE, size = 1.25)
q <- q + geom_abline(intercept=0, slope=1, linetype = "dotted", alpha = 0.75)
q <- q + labs(list(title = "Sales by Quota by Group \nwith lm fit and identity line"
              , x = "Quota (1000's)", y = "Sales (1000's)")) + theme_bw()
q
```

### Attainment / Target

The attainment variable supplied in the data set is simply the ratio of \(\frac{Sales}{Quota}\) and represents the performance of individual sales agents. It is equivalent to fitting linear model Sales ~ Quota, assuming the intercept is 0.

More generally

\[Y = \beta_0 + \beta_1X + \epsilon\]

where \(X\) is Quota and \(Y\) is Sales. 

The task at hand is to determine if there are any discernable patterns to the residual varation \(\epsilon\), that which is unexplained by the linear relationship between Sales and Quota. 


The following figure shows that the on target attainment for group A is relatively constant, no matter what the Quota (as was seen in the previous figure). 

For Group B the picture is not so clear. In the shadow of much higher variance, there appears to be a different trend; As was seen in the exploratory box plot, those with lower quotas may be finding it easier to meet and exceed the attainment while those with higher quotas struggle. This pattern is less clear and the regression line may be heavily influenced by a small number of significant outliers.

There is a pattern of heteroskedasticity over the whole population, whereby the lower quotas are much poorer estimators of sales than the higher quotas. 

This could also be a factor influencing group B outcomes because they are all in the lower range of quotas.

```{r Exploratory_Graph_Attainment_Quota}
q <- qplot(data = raw.data, x = KQuota, y = OnTarget
      , colour = Group, alpha = I(0.5))
q <- q + geom_smooth(method = "lm", se = FALSE, size = 1.25)
q <- q + labs(list(title = "Attainment by Quota by Group with lm fit"
              , x = "Quota (1000's)", y = "Sales (1000's)")) + theme_bw()
q
```

## Linear Modeling
Attainment is the unit free function of sales and is taken as the dependent variable, based on the assumption that quotas are set to drive sales. The Quota data is centred for each group with \(X - \mu\).

The other independent variable is the Group asignment, a factor variable, either A or B.

The only model constructed for this report includes both the independent variables.

```{r lm_Sales_depends_Quota_and_Group}
# centering each group in its attainment mean
raw.data$Sales_C <- KSales - ifelse(Group == "A", mn_Sal_A, mn_Sal_B)
raw.data$Quota_C <- KQuota - ifelse(Group == "A", mn_Quo_A, mn_Quo_B)
raw.data$OnTarget_C <- OnTarget - ifelse(Group == "A", mn_Tar_A, mn_Tar_B)

attach(raw.data)

lm1 <- lm(OnTarget ~ Group * Quota_C -1)
summary(lm1)
```

Unsurprisingly, this model returns a slope coefficient for Group A of 0.00186, almost no effect at all on attainment as was discovered in the EDA.

Group B falls at a rate, 0.00186 - 0.48499 = -0.48027

According to this model, Group B loses 0.5 percentage points of attainment for every 1000 units of quota above the average.

The following plot is the residuals in increasing order, seeking any discernable pattern in their distribution. The variance is evident, with the central values being sparsely populated by Group B

The Quota (scaled) has been superimposed on the series to seek any relationship between it the on target attainment, but there seems to be nothing beyond a noisy flat line. In fact the peak Quota value around 245 is only slightly above zero.

```{r Resid_Diagnostics}
n = nrow(raw.data)
id = 1:n
lm1_res_dgn <- data.frame(res = sort(resid(lm1))
                          , idx = as.numeric(names(sort(resid(lm1))))
                          , id= id, row.names = id)
lm1_res_dgn$KQuota <- KQuota[lm1_res_dgn$idx]
lm1_res_dgn$Group <- Group[lm1_res_dgn$idx]
lm1_res_dgn$jitter <- rnorm(n, sd = 0.25)

xyplot((res+jitter)~id
       , data = lm1_res_dgn
       , group = Group
       , main = list("Ordered Residuals", cex = 1)
       , ylab = "Jittered on target attainment (residuals)"
       , panel = function(x,y,...) {
         panel.xyplot(x,y,..., alpha = c(0.5, 0.8), pch = c(1, 19))
         panel.xyplot(x,y = lm1_res_dgn$KQuota/5-35,...
                      , alpha = c(0.4, 0.5), type = "l")
       })
```

The following plot show the ordered Cooks Distances. Colouring is again used to emphasis the difference between the groups and again the Quota (scaled) has been superimposed on the series. It  appears as though the very lowest quotas have delivered the wildest variation in performance.

```{r cooks_diagnostics}
n = nrow(raw.data)
id = 1:n
lm1_cks_dgn <- data.frame(cks = sort(cooks.distance(lm1))
                          , idx = as.numeric(names(sort(cooks.distance(lm1))))
                          , id= id, row.names = id)
lm1_cks_dgn$KQuota <- KQuota[lm1_cks_dgn$idx]
lm1_cks_dgn$OnTarget <- OnTarget[lm1_cks_dgn$idx]
lm1_cks_dgn$Group <- Group[lm1_cks_dgn$idx]
lm1_cks_dgn$jitter <- rnorm(n, sd = 0.001)

xyplot((cks+jitter)~id
       , data = lm1_cks_dgn
       , group = Group
       , main = list("Ordered Residual Cooks Distances", cex = 1)
       , ylab = "Jittered residuals Cooks distances"
       , panel = function(x,y,...) {
         panel.xyplot(x,y,..., alpha = c(0.4, 0.8), pch = c(1, 19))
         panel.xyplot(x,y = lm1_cks_dgn$KQuota/1500+0.1,...
                      , alpha = c(0.4, 0.5), type = "l")
         panel.abline(v=300, lty = "dotted", col = "black", alpha = 0.5)
         panel.text("High variance\nin Group B"
                    , x = 375, y = 0.075, cex = 0.7)
         })
```

All bar the most influential point have a quota well below the group average. The 2nd and third position show attainments both wildly above and below the expected zero mark. No data points for Group A are retuned:

```{r cooks_distances_detail}
head(lm1_cks_dgn[nrow(lm1_cks_dgn):1, c("cks", "KQuota", "OnTarget", "Group")],10)
```

## Conclusion

Based on the information available, quota rigging cannot be completely ruled out but there is no evidence of any systemic problem. Only a more detailed analysis, focusing on specific individuals who have outperformed there expected attainment would be able to address this. 

However, the quota setting process is failing as a predictor of attainment at the lower range of quotas. Group B are heavily represented within this low range and their attainments are out by as much as \(\pm50\) percentage points. This process may benefit from a review.

#### Side note on the linear relationship; Sales ~ Quota:

The simple 1:1 relationship so far discovered, is actually rather unintuitive as it is not conceivable that one could continually increase the quota and get a linear increase in sales to infinity. The reality is much more likely to be a log relationship, with sales vastly outstripping lower quotas then trailing behind higher and higher quotas to a limit. It is assumed that this log relationship is being mediated by some modeling of easier or tougher customer groups. This is perhaps the task of the sales manager or VP in charge to ensure the targets are realistic and achievable for each individual.

Without any information about how the customers are modeled, the linear relationship is assumed to be this intuited process combined with the log relationship all rolled up into the value of the slope coefficient \(\beta_1\) of the linear model. No judgements can be made with the available data about how fair the the process of quota setting is at this level of detail.

```{r expected_loglinear_increase_in_sales}
x <- seq(5, 80, 0.5)
y <- 9*log(x) + rnorm(length(x))
xyplot(y~x, main = list("Intuitive relationship of Sales to Quotas\n(Simulation)", cex = 1)
      , xlab = "Quota (1000's)", ylab = "Sales (1000's)")
```

```{r variance_as_a_predictor}
k <- 50
wndws <- cbind(lwr = 0:(422-k), idx = floor(k/2):(422-floor(k/2)), upr = k:422)

rollingSD <- as.numeric(rep(NA, 422))
for (i in 1:dim(wndws)[1]) {
  rollingSD[wndws[i,"idx"]] <-  sd(raw.data$OnTarget[order(raw.data$Quota, decreasing = FALSE)][wndws[i,"lwr"]:wndws[i,"upr"]])
}

raw.data <- cbind(raw.data[order(raw.data$Quota, decreasing = FALSE),], rollingSD)

q <- qplot(data = raw.data, x = KQuota, y = rollingSD
       , colour = Group, alpha = I(0.5), xlim = c(15,52))
q <- q + geom_smooth(span = 0.2, degree = 0, size = 1.25)
q <- q + labs(list(title = "Heteroskedastic Trend by Quota by Group"
              , x = "Quota (1000's)", y = "Missing variable - falling variance")) + theme_bw()
q
```